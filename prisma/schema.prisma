// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE   @map("Male") // Male
  FEMALE @map("Female") // Female
  OTHER  @map("Other") // Other
}

enum StaffRole {
  ADMIN     @map("Admin") // Admin 
  MANAGER   @map("Manager") // Manager
  STAFF     @map("Staff") // Staff
  VOLUNTEER @map("Volunteer") // Volunteer
}

enum StaffStatus {
  ACTIVE     @map("Active") // Currently working
  INACTIVE   @map("Inactive") // Not working
  ON_LEAVE   @map("On Leave") // On leave
  TERMINATED @map("Terminated") // Terminated
  SUSPENDED  @map("Suspended") // Suspended
  RESIGNED   @map("Resigned") // Resigned
  OTHER      @map("Other") // Other
}

enum RelationType {
  CHILD       @map("Child") // Child
  SPOUSE      @map("Spouse") // Spouse
  PARENT      @map("Parent") // Parent
  SIBLING     @map("Sibling") // Sibling
  GRANDPARENT @map("Grandparent") // Grandparent
  GUARDIAN    @map("Guardian") // Guardian
  FRIEND      @map("Friend") // Friend
  NEIGHBOR    @map("Neighbor") // Neighbor  
  COUSIN      @map("Cousin") // Cousin
  OTHER       @map("Other") // Other
}

/// Represents a person's profile information
model Profile {
  id       String    @id @default(cuid()) // Unique identifier for the profile  
  fullName String // Full name of the person
  dob      DateTime? // Date of birth
  gender   Gender? // Gender of the person
  phone    String? // Phone number
  email    String? // Email address
  image    String? // Profile image URL

  // Relationships
  user        User?        @relation(fields: [userId], references: [id]) // User associated with the profile
  userId      String?      @unique // Unique identifier for the user
  staff       Staff? // Staff member associated with the profile
  beneficiary Beneficiary? // Beneficiary associated with the profile

  createdAt DateTime @default(now()) // Date and time when the profile was created
  updatedAt DateTime @updatedAt // Date and time when the profile was last updated  
}

/// Represents an authenticated user in the system.
model User {
  id            String    @id @default(cuid()) // Unique identifier for the user
  email         String?   @unique // Email address of the user
  password      String? // Password of the user
  emailVerified DateTime? // Date and time when the email was verified
  createdAt     DateTime  @default(now()) // Date and time when the user was created
  updatedAt     DateTime  @updatedAt // Date and time when the user was last updated

  // Relations
  accounts  Account[] // Associated accounts
  sessions  Session[] // Active sessions
  userRoles UserRole[] // Assigned roles
  auditLogs AuditLog[] // Audit logs
  Document  Document[] // Documents associated with the user

  profile       Profile? // Shared person details
  staffProfiles Staff[] // Staff profiles associated with the user
  beneficiaries Beneficiary[] @relation("UserBeneficiaries") // Beneficiaries associated with the user
  guardianOf    Beneficiary[] @relation("UserGuardians") // Guardians associated with the user
}

/// Represents a staff member in an organization
model Staff {
  id             String      @id @default(cuid()) // Unique identifier for the staff member
  profileId      String      @unique // Unique identifier for the staff member's profile
  organizationId String // Identifier for the organization the staff member belongs to
  role           StaffRole // Role of the staff member
  startDate      DateTime // Date and time when the staff member started working
  endDate        DateTime? // Date and time when the staff member's employment ended
  status         StaffStatus // Current status of the staff member
  createdAt      DateTime    @default(now()) // Date and time when the staff member was created
  updatedAt      DateTime    @updatedAt // Date and time when the staff member was last updated

  userId String // Still maintain this for backref to identity

  // Relations
  user          User          @relation(fields: [userId], references: [id]) // User associated with the staff member
  profile       Profile       @relation(fields: [profileId], references: [id]) // Profile details of the staff member
  organization  Organization  @relation(fields: [organizationId], references: [id]) // Organization the staff member belongs to
  beneficiaries Beneficiary[] // Beneficiaries associated with the staff member
}

/// Represents a beneficiary in the system
model Beneficiary {
  id          String       @id @default(cuid()) // Unique identifier for the beneficiary
  profileId   String       @unique // Unique identifier for the beneficiary's profile
  relation    RelationType // Type of relationship between the beneficiary and the staff member
  isStaffLink Boolean      @default(false) // Whether the beneficiary is linked to a staff member
  staffId     String // Identifier for the staff member the beneficiary is linked to
  guardianId  String? // Identifier for the guardian of the beneficiary
  userLinkId  String? // Identifier for the user the beneficiary is linked to

  // Relations
  profile  Profile @relation(fields: [profileId], references: [id]) // Profile details of the beneficiary
  staff    Staff   @relation(fields: [staffId], references: [id]) // Staff member the beneficiary is linked to
  guardian User?   @relation("UserGuardians", fields: [guardianId], references: [id]) // Guardian of the beneficiary
  userLink User?   @relation("UserBeneficiaries", fields: [userLinkId], references: [id]) // User the beneficiary is linked to

  createdAt DateTime @default(now()) // Date and time when the beneficiary was created
  updatedAt DateTime @updatedAt // Date and time when the beneficiary was last updated
}

/// Links a user to an external identity provider (Microsoft, GitHub, etc).
model Account {
  id                String  @id @default(cuid()) // Unique account ID.
  userId            String // FK to User.
  type              String // Account type ('oauth', 'oidc', etc).
  provider          String // Provider name (e.g. 'microsoft').
  providerAccountId String // User ID on the provider side.
  refresh_token     String? // OAuth refresh token.
  access_token      String? // OAuth access token.
  expires_at        Int? // Expiry timestamp (UNIX).
  token_type        String? // Type of token (Bearer, etc).
  scope             String? // OAuth scopes.
  id_token          String? // ID token (JWT).
  session_state     String? // Used for OIDC session management.

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) // Relation to User.

  @@unique([provider, providerAccountId]) // Prevents duplicates per provider+user combo.
}

/// Stores active sessions for stateless authentication (JWT or DB).
model Session {
  id           String   @id @default(cuid()) // Unique session ID.
  sessionToken String   @unique // Token stored in cookie.
  userId       String // FK to User.
  expires      DateTime // Expiration date of session.

  user User @relation(fields: [userId], references: [id])
}

/// Used for email/passwordless login flows or account recovery.
model VerificationToken {
  identifier String // Email or phone identifier.
  token      String   @unique // One-time token (sent via email/SMS).
  expires    DateTime // Expiration timestamp.

  @@unique([identifier, token]) // Ensures no reuse per email/token combo.
}

/// Represents a group of permissions (e.g. 'Admin', 'Manager', 'User').
model Role {
  id          String  @id @default(cuid()) // Unique role ID.
  name        String  @unique // Role name.
  description String? // Optional description.

  permissions RolePermission[] // Assigned permissions.
  users       UserRole[] // Users with this role.
}

/// Represents a single action a user can perform (e.g. 'view_users', 'edit_asset').
model Permission {
  id          String  @id @default(cuid()) // Unique permission ID.
  name        String  @unique // Permission name/code.
  description String? // Optional details.

  roles RolePermission[] // Roles that include this permission.
}

/// Pivot table assigning permissions to roles.
model RolePermission {
  id           String @id @default(cuid()) // Unique ID.
  roleId       String // FK to Role.
  permissionId String // FK to Permission.

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId]) // Prevent duplicate entries.
}

/// Assigns one or more roles to a user.
model UserRole {
  id     String @id @default(cuid()) // Unique ID.
  userId String // FK to User.
  roleId String // FK to Role.

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId]) // Prevent duplicate role assignments.
}

/// Represents an industry classification
model Industry {
  id          String     @id @default(cuid())
  name        String     @unique // Industry name
  code        String?    @unique // Optional industry code (e.g., NAICS, SIC)
  description String? // Optional description
  parentId    String? // Reference to parent industry for hierarchical structure
  parent      Industry?  @relation("IndustryHierarchy", fields: [parentId], references: [id])
  children    Industry[] @relation("IndustryHierarchy")

  organizations Organization[] // Organizations in this industry

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([code])
  @@index([parentId])
}

/// Represents a client or partner organization in the system
model Organization {
  id            String    @id @default(cuid())
  name          String // Organization's legal name
  email         String? // Primary contact email
  phone         String? // Primary contact phone
  address       String? // Physical address
  contactPerson String? // Primary contact person's name
  contactEmail  String? // Contact person's email
  contactPhone  String? // Contact person's phone
  industryId    String? // Reference to primary industry
  industry      Industry? @relation(fields: [industryId], references: [id])
  status        OrgStatus @default(ACTIVE) // Current status of the organization
  notes         String? // Additional notes or comments
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  contracts         Contract[] // Active contracts with this organization
  Document          Document[] // Documents associated with this organization
  KPI               KPI[]
  KPIAssignment     KPIAssignment[]
  ServiceAssignment ServiceAssignment[]
  Staff             Staff[]

  @@index([status]) // Index for faster status-based queries
  @@index([name]) // Index for faster name-based searches
  @@index([email]) // Index for faster email lookups
  @@index([industryId]) // Index for faster industry-based queries
}

/// Represents a service contract between the organization and a client
model Contract {
  id             String       @id @default(cuid())
  organizationId String // Reference to the organization
  organization   Organization @relation(fields: [organizationId], references: [id])

  startDate   DateTime // Contract start date
  endDate     DateTime // Contract end date
  renewalDate DateTime? // Optional date when contract can be renewed
  billingRate Float // Rate charged for services
  isRenewable Boolean   @default(true) // Whether the contract can be renewed

  // Payment tracking fields
  paymentFrequency String? // How often payments are made (monthly, quarterly, etc.)
  paymentTerms     String? // Payment terms (net 30, net 60, etc.)
  currency         String?   @default("USD") // Currency for billing
  lastBillingDate  DateTime? // When the last payment was processed
  nextBillingDate  DateTime? // When the next payment is due

  documentUrl String? // URL to the signed contract document
  status      ContractStatus @default(ACTIVE) // Current status of the contract
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  Document          Document[] // Related documents (contract terms, amendments, etc.)
  KPI               KPI[]
  KPIAssignment     KPIAssignment[]
  ServiceAssignment ServiceAssignment[]

  @@index([organizationId]) // Index for faster organization contract queries
  @@index([status]) // Index for faster status-based queries
  @@index([endDate]) // Index for faster expiry date queries
}

/// Represents a document in the system (contracts, reports, certifications, etc.)
model Document {
  id                String       @id @default(cuid())
  title             String // Document title/name
  description       String? // Optional document description
  type              DocumentType // Type of document (contract, report, etc.)
  url               String // Storage link (S3, etc.)
  fileSize          Int? // File size in bytes
  fileType          String? // MIME type of the file
  version           Int          @default(1) // Document version number
  isLatest          Boolean      @default(true) // Indicates if this is the latest version
  previousVersionId String? // Reference to previous version
  previousVersion   Document?    @relation("DocumentVersions", fields: [previousVersionId], references: [id])
  nextVersions      Document[]   @relation("DocumentVersions")

  uploadedById   String? // User ID who uploaded the document
  uploadedBy     User?         @relation(fields: [uploadedById], references: [id])
  organizationId String? // Associated organization
  organization   Organization? @relation(fields: [organizationId], references: [id])
  contractId     String? // Associated contract
  contract       Contract?     @relation(fields: [contractId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type]) // Index for faster document type queries
  @@index([organizationId]) // Index for faster organization document queries
  @@index([contractId]) // Index for faster contract document queries
  @@index([uploadedById]) // Index for faster user document queries
}

// ENUM: Document types
enum DocumentType {
  CONTRACT           @map("contract") // Contract
  CERTIFICATION      @map("certification") // Certification
  KPI_REPORT         @map("kpi_report") // KPI Report
  FEEDBACK_SUMMARY   @map("feedback_summary") // Feedback Summary
  BILLING_REPORT     @map("billing_report") // Billing Report
  UTILIZATION_REPORT @map("utilization_report") // Utilization Report
  OTHER              @map("other") // Other
}

// ENUM: Organization status
enum OrgStatus {
  ACTIVE     @map("Active") // Active
  INACTIVE   @map("Inactive") // Inactive
  TERMINATED @map("Terminated") // Terminated
  PENDING    @map("Pending") // Pending
}

// ENUM: Contract status
enum ContractStatus {
  ACTIVE     @map("Active") // Active 
  EXPIRED    @map("Expired") // Expired
  TERMINATED @map("Terminated") // Terminated
  RENEWED    @map("Renewed") // Renewed
}

/// Represents an audit log entry
model AuditLog {
  id        String   @id @default(cuid()) // Unique identifier for the audit log  
  action    String // Action performed (e.g., 'create', 'update', 'delete')
  data      Json? // Additional data related to the action
  timestamp DateTime @default(now()) // Date and time when the action was performed
  User      User?    @relation(fields: [userId], references: [id]) // User who performed the action
  userId    String? // User ID of the user who performed the action 
  // @@map("audit_logs") // Table name in the database

  @@index([action]) // Index for faster action-based queries
  @@index([timestamp]) // Index for faster timestamp-based queries  
}

/// Represents a Key Performance Indicator (KPI) in the system
model KPI {
  id          String  @id @default(cuid())
  name        String // Name of the KPI
  description String? // Optional description
  type        String // Category or type of KPI
  unit        String // Unit of measurement (%, $, number, etc.)
  unitType    Unit // New enum-based unit type
  isActive    Boolean @default(true) // Whether the KPI is active in the catalog

  // Relations
  assignments KPIAssignment[] // KPI assignments to contracts

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  Organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  Contract       Contract?     @relation(fields: [contractId], references: [id])
  contractId     String?

  @@index([type]) // For filtering by KPI type
  @@index([isActive]) // For filtering active/inactive KPIs
}

/// Represents an assignment of a KPI to a contract
model KPIAssignment {
  id          String           @id @default(cuid())
  kpiId       String // Reference to the KPI
  contractId  String // Reference to the contract
  targetValue String? // E.g., "12 sessions", "1 report/month"
  frequency   Frequency // How often the KPI is measured
  status      AssignmentStatus // Current status of the assignment
  notes       String? // Additional notes
  startDate   DateTime // When the KPI assignment starts
  endDate     DateTime? // Optional end date for the assignment

  // Relations
  kpi      KPI      @relation(fields: [kpiId], references: [id])
  contract Contract @relation(fields: [contractId], references: [id])

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  Organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  @@index([kpiId]) // For faster KPI lookups
  @@index([contractId]) // For contract assignments
  @@index([status]) // For status-based queries
  @@index([startDate]) // For date-based queries
}

/// Represents how often a KPI is measured
enum Frequency {
  ONCE      @map("Once") // Once
  WEEKLY    @map("Weekly") // Weekly
  MONTHLY   @map("Monthly") // Monthly
  QUARTERLY @map("Quarterly") // Quarterly
  ANNUALLY  @map("Annually") // Annually
}

/// Represents the status of an assignment
enum AssignmentStatus {
  PENDING   @map("Pending") // Pending
  ONGOING   @map("Ongoing") // Ongoing
  COMPLETED @map("Completed") // Completed
  CANCELLED @map("Cancelled") // Cancelled
}

enum KpiCategory {
  UTILIZATION      @map("Utilization") // Utilization
  SERVICE_DELIVERY @map("Service Delivery") // Service Delivery
  SATISFACTION     @map("Satisfaction") // Satisfaction
  COMPLIANCE       @map("Compliance") // Compliance
  ENGAGEMENT       @map("Engagement") // Engagement
  IMPACT           @map("Impact") // Impact
}

enum Unit {
  PERCENTAGE @map("Percentage") // %
  COUNT      @map("Count") // Integer count
  SCORE      @map("Score") // e.g., Satisfaction out of 10
  TIME       @map("Time") // Duration e.g., in minutes/days
}

enum ServiceStatus {
  ACTIVE    @map("Active") // Active  
  INACTIVE  @map("Inactive") // Inactive
  SUSPENDED @map("Suspended") // Suspended
}

model ServiceCategory {
  id          String   @id @default(cuid()) // Unique identifier for the service category
  name        String   @unique // Name of the service category
  description String? // Optional description of the service category
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[] // Services associated with this category
}

model Service {
  id          String          @id @default(cuid()) // Unique identifier for the service
  name        String // Name of the service
  description String? // Optional description of the service
  categoryId  String // Reference to the service category
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  status      ServiceStatus   @default(ACTIVE) // Current status of the service

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments ServiceAssignment[] // Assignments of this service to contracts
}

model ServiceAssignment {
  id         String           @id @default(cuid()) // Unique identifier for the service assignment
  serviceId  String // Reference to the service
  contractId String // Reference to the contract
  service    Service          @relation(fields: [serviceId], references: [id])
  contract   Contract         @relation(fields: [contractId], references: [id])
  status     AssignmentStatus @default(PENDING) // Current status of the assignment
  startDate  DateTime // When the service assignment starts
  endDate    DateTime? // Optional end date for the assignment
  frequency  Frequency // How often the service is provided

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  Organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  @@index([status]) // For status-based queries
  @@index([startDate]) // For date-based queries
}
